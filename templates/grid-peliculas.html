{% extends 'base.html' %} {% block title %}Películas{% endblock %} {% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/grid.css') }}">{% endblock %} {% block content %}
<section>
    <h2 class="mb-3" id="tituloPeliculas"></h2>
    <div class="poster-grid" id="peliculas"></div>
</section>
{% endblock %} {% block scripts %}
<script>
    const API = "http://127.0.0.1:5000/api";
    const tipo = "{{ tipo }}";

    function crearCard(data) {
        const col = document.createElement("div");

        const link = document.createElement("a");
        link.href = `/peliculas/${data.id}`;
        link.classList.add("text-decoration-none", "text-reset");

        const card = document.createElement("div");
        card.classList.add("poster-card");

        const img = document.createElement("img");
        img.src = data.imageUrl || "/static/img/placeholder.png"; // fallback
        img.classList.add("poster");
        img.alt = data.title || "Imagen de la película";
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.classList.add("card-img-overlay");

        const title = document.createElement("h5");
        title.classList.add("card-title");
        title.textContent = data.title || "Sin título";
        overlay.appendChild(title);

        const rating = document.createElement("p");
        rating.classList.add("card-text");
        const score = typeof data.vote_average === "number" && !isNaN(data.vote_average) ? data.vote_average.toFixed(1) : "N/D";
        rating.textContent = `⭐ ${score}`;
        overlay.appendChild(rating);

        card.appendChild(overlay);
        const boton = crearBotonLista(data);
        card.appendChild(boton);

        link.appendChild(card);
        col.appendChild(link);

        return col;
    }

    function crearBotonLista(data) {
        const boton = document.createElement("button");
        boton.classList.add("btn", "btn-add");
        boton.textContent = "+";
        boton.dataset.id = data.id;
        boton.dataset.added = "false";

        boton.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const id = boton.dataset.id;
            const added = boton.dataset.added === "true";

            try {
                const method = added ? "DELETE" : "POST";
                const resp = await fetch(`/api/mi-lista/${id}/`, { method });

                if (resp.ok) {
                    const nuevoEstado = !added;
                    boton.dataset.added = nuevoEstado;
                    boton.textContent = nuevoEstado ? "✕" : "+";
                    boton.classList.toggle("btn-danger", nuevoEstado);
                } else {
                    alert("Error al actualizar la lista");
                }
            } catch (err) {
                console.error("Error con la API:", err);
            }
        });

        return boton;
    }

    async function cargarPeliculas() {
        console.log("Ejecutando cargarPeliculas() con tipo:", tipo);

        try {
            const resp = await fetch(`${API}/peliculas/${tipo}`);
            if (!resp.ok) throw new Error("Error al obtener películas");

            const json = await resp.json();
            const data = json.data || [];

            document.getElementById("tituloPeliculas").textContent = tipo.replace("_", " ").toUpperCase();

            const lista = document.getElementById("peliculas");
            lista.innerHTML = "";

            data.forEach((p) => lista.appendChild(crearCard(p)));
        } catch (err) {
            console.error("Error:", err);
        }
    }

    document.addEventListener("DOMContentLoaded", cargarPeliculas);
</script>
{% endblock %}
