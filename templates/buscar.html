{% extends 'base.html' %} {% block title %}Resultados de b√∫squeda{% endblock %} {% block content %}

<h2 id="titulo-busqueda">Resultados de b√∫squeda</h2>
<div class="row row-cols-1 row-cols-md-6 g-4" id="peliculas"></div>

{% endblock %} {% block scripts %}
<script>
    const API = "http://127.0.0.1:5000/api";

    function crearCard(data) {
        const col = document.createElement("div");
        col.classList.add("col");

        const link = document.createElement("a");
        link.href = `/peliculas/${data.id}`;
        link.classList.add("text-decoration-none", "text-reset");

        const card = document.createElement("div");
        card.classList.add("card", "text-bg-grey", "mb-3");

        const img = document.createElement("img");
        img.src = data.imageUrl;
        img.classList.add("card-img");
        img.alt = data.title || "Imagen no disponible";
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.classList.add("card-img-overlay");

        const title = document.createElement("h5");
        title.classList.add("card-title");
        title.textContent = data.title;
        overlay.appendChild(title);

        // ‚≠ê Mostrar solo si hay rating v√°lido
        if (data.vote_average && data.vote_average !== "N/A" && data.vote_average !== 0) {
            const rating = document.createElement("p");
            rating.classList.add("card-text");
            rating.textContent = `‚≠ê ${data.vote_average}`;
            overlay.appendChild(rating);
        }

        const boton = crearBotonLista(data);
        overlay.appendChild(boton);

        card.appendChild(overlay);
        link.appendChild(card);
        col.appendChild(link);

        return col;
    }

    function crearBotonLista(data) {
        const boton = document.createElement("a");
        boton.classList.add("btn", "btn-primary");
        boton.textContent = "‚ûï";
        boton.dataset.id = data.id;
        boton.dataset.added = "false";

        boton.addEventListener("click", async (e) => {
            e.preventDefault();
            const id = boton.dataset.id;
            const added = boton.dataset.added === "true";

            try {
                if (!added) {
                    const resp = await fetch(`/api/mi-lista/${id}/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user_id: 1,
                            titulo: data.title,
                            poster_url: data.imageUrl,
                        }),
                    });

                    if (resp.ok) {
                        boton.textContent = "‚úñÔ∏è";
                        boton.classList.replace("btn-primary", "btn-danger");
                        boton.dataset.added = "true";
                    }
                } else {
                    const resp = await fetch(`/api/mi-lista/${id}/`, { method: "DELETE" });
                    if (resp.ok) {
                        boton.textContent = "‚ûï";
                        boton.classList.replace("btn-danger", "btn-primary");
                        boton.dataset.added = "false";
                    }
                }
            } catch (err) {
                console.error("Error con la API:", err);
            }
        });

        return boton;
    }

    async function cargarResultados() {
        const params = new URLSearchParams(window.location.search);
        const query = params.get("q");
        const lista = document.getElementById("peliculas");
        const tituloBusqueda = document.getElementById("titulo-busqueda");

        if (!query) {
            lista.innerHTML = "<p class='text-center mt-4'>No se ingres√≥ ning√∫n t√©rmino de b√∫squeda.</p>";
            return;
        }

        tituloBusqueda.textContent = `Resultados para: "${query}"`;

        try {
            const resp = await fetch(`${API}/buscar?q=${encodeURIComponent(query)}`);
            const json = await resp.json();

            if (json.status === "success" && json.data.length > 0) {
                lista.innerHTML = "";

                // üîπ FILTRAR pel√≠culas vac√≠as
                const filtradas = json.data.filter((p) => p.title && p.title.trim() !== "" && p.imageUrl && !p.imageUrl.includes("placeholder"));

                if (filtradas.length === 0) {
                    lista.innerHTML = `<p class='text-center mt-4'>No se encontraron resultados v√°lidos para <b>${query}</b>.</p>`;
                    return;
                }

                filtradas.forEach((p) => {
                    const nuevaCard = crearCard(p);
                    lista.appendChild(nuevaCard);
                });
            } else {
                lista.innerHTML = `<p class='text-center mt-4'>No se encontraron resultados para <b>${query}</b>.</p>`;
            }
        } catch (err) {
            console.error("Error al buscar:", err);
            lista.innerHTML = "<p class='text-center text-danger mt-4'>Error al cargar resultados.</p>";
        }
    }

    window.addEventListener("DOMContentLoaded", cargarResultados);
</script>
{% endblock %}
