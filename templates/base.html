<!DOCTYPE html>
<html lang="es">
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>{% block title %}{% endblock %}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" id="favicon.ico" type="image/x-icon" />
    </head>
    <body>
        <nav class="navbar">
            <div class="container-fluid">
                <a class="navbar-brand navbar-titulo" href="{{url_for('home')}}">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" width="50" height="50" class="d-inline-block align-text-top" />
                    TomaUNO
                </a>

                <form class="d-flex" role="search" onsubmit="return buscarRedirect(event)">
                    <input id="searchInput" class="form-control me-2 buscar" type="search" placeholder="Buscar" aria-label="Search" />
                </form>

                <div class="d-flex align-items-end">
                    <span id="online-users" class="badge bg-success me-3" style="font-size: 0.9rem;">
                        <span id="user-count">0</span> en línea
                    </span>
                    <button id="btn-login" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalLogin">Iniciar sesión</button>
                    <div id="user-menu" class="dropdown d-none ms-2">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">Mi cuenta</button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/perfil">Perfil</a></li>
                            <li><a class="dropdown-item text-danger" href="#" id="btn-logout">Cerrar sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
        {% block content %}{% endblock %}
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <script>
            (function () {
                try {
                    const socket = io();
                    window.appSocket = socket;
                    
                    socket.on("connect", function () {
                        console.log("Conectado al servidor. Tu ID:", socket.id);
                        socket.emit("ping", { ts: Date.now() });
                    });
                    
                    socket.on("disconnect", function () {
                        console.log("Desconectado del servidor");
                    });
                    
                    socket.on("welcome", function (data) {
                        console.log("Bienvenida recibida:", data);
                        updateOnlineCount(data.total_clients);
                    });
                    
                    socket.on("pong", function (data) {
                        console.log("Pong recibido:", data);
                    });
                    
                    socket.on("online_count", function (data) {
                        console.log("Usuarios en línea:", data.count);
                        updateOnlineCount(data.count);
                    });
                    
                    socket.on("chat_message", function (data) {
                        console.log("Mensaje recibido de", data.from + ":", data.text);
                    });
                    
                    function updateOnlineCount(count) {
                        const countElement = document.getElementById("user-count");
                        if (countElement) {
                            countElement.textContent = count;
                        }
                    }
                } catch (e) {
                    console.error("Error al inicializar Socket.IO:", e);
                }
            })();

            function buscarRedirect(e) {
                e.preventDefault();
                const query = document.getElementById("searchInput").value.trim();
                if (query) {
                    window.location.href = `/buscar?q=${encodeURIComponent(query)}`;
                }
                return false;
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
        <script src="{{url_for('static', filename='navbar.js')}}"></script>
        {% block scripts %}{% endblock %}
    </body>
</html>
