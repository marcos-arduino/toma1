{% extends 'base.html' %} {% block title %}Testing de Componentes{% endblock %} {% block content %}
<section>
    <h2 class="mb-3">Pel√≠culas populares</h2>
    <div class="poster-grid" id="peliculas"></div>
    
</section>
{% endblock %} {% block scripts %}
<script>
    const API = "http://127.0.0.1:5000/api";

    function crearCard(data) {
        const col = document.createElement("div");
        const link = document.createElement("a");
        link.href = `/peliculas/${data.id}`;
        link.classList.add("text-decoration-none", "text-reset");

        const card = document.createElement("div");
        card.classList.add("poster-card");

        const img = document.createElement("img");
        img.src = data.imageUrl;
        img.classList.add("poster");
        img.alt = "Imagen de la pelicula";
        card.appendChild(img);

        const overlay = document.createElement("div");
        overlay.classList.add("card-img-overlay");

        const title = document.createElement("h5");
        title.classList.add("card-title");
        title.textContent = data.title;
        overlay.appendChild(title);

        const rating = document.createElement("p");
        rating.classList.add("card-text");
        const score = (typeof data.vote_average === 'number' && !isNaN(data.vote_average))
            ? (Math.round(data.vote_average * 10) / 10).toFixed(1)
            : 'N/D';
        rating.textContent = `‚≠ê ${score}`;
        overlay.appendChild(rating);

        const boton = crearBotonLista(data);
        card.appendChild(boton);

        // const text = document.createElement("p");
        // text.classList.add("card-text");
        // text.textContent = data.text;
        // overlay.appendChild(text);

        card.appendChild(overlay);
        link.appendChild(card);
        col.appendChild(link);

        return col;
    }

    function crearBotonLista(data) {
        const boton = document.createElement("a");
        boton.classList.add("btn", "btn-add");
        boton.textContent = "+";
        boton.dataset.id = data.id;
        boton.dataset.added = "false"; // üîπ estado inicial

        boton.addEventListener("click", async (e) => {
            e.preventDefault(); // evita redirecci√≥n
            e.stopPropagation(); // evita que el click active el enlace del poster

            const id = boton.dataset.id;
            const added = boton.dataset.added === "true";

            try {
                if (!added) {
                    const resp = await fetch(`/api/mi-lista/${id}/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    });

                    if (resp.ok) {
                        boton.textContent = "‚úï";
                        boton.classList.add("btn-danger");
                        boton.dataset.added = "true";
                    } else {
                        alert("Error al agregar la pel√≠cula");
                    }
                } else {
                    const resp = await fetch(`/api/mi-lista/${id}/`, {
                        method: "DELETE",
                    });

                    if (resp.ok) {
                        boton.textContent = "+";
                        boton.classList.remove("btn-danger");
                        boton.dataset.added = "false";
                    } else {
                        alert("Error al eliminar la pel√≠cula");
                    }
                }
            } catch (err) {
                console.error("Error con la API:", err);
            }
        });

        return boton;
    }

    async function cargarPeliculas() {
        console.log("Ejecutando cargarPeliculas()");
        const resp = await fetch(`${API}/peliculas-popular`);
        const json = await resp.json();
        console.log("Respuesta:", json);

        const data = json.data;
        console.log("Data:", data);
        const lista = document.getElementById("peliculas");
        lista.innerHTML = "";
        data.forEach((p) => {
            const nuevaCard = crearCard(p);
            lista.appendChild(nuevaCard);
        });
    }

    window.addEventListener("DOMContentLoaded", cargarPeliculas);
</script>
{% endblock %}
